# Database structure

For an auth service with Cognito-like features, a relational core + fast cache is the sweet spot:

## Storage layout

1. Primary storage: PostgreSQL
   - Strong consistency, joins, migrations auditability

2. Cache / ephemeral store: Redis
   - Session state, rate limit, short-lived OTP/MFA challenges, JTI(Just In Time) blacklists.

3. Long-term log/archive (Optional): S3/MiniO
   - Object store or Append-only table/warehouse for compliance exports.

## Core relational schema

### Users & Credentials

- Users

```plaintext
  id (UUID, PK)
  tenant_id (UUID, FK to Tenant)
  email (VARCHAR, unique, indexed)
  first_name (VARCHAR, unique, indexed)
  last_name (VARCHAR, unique, indexed)
  created_at (TIMESTAMP)
  updated_at (TIMESTAMP)
  is_active (BOOLEAN)
  is_verified (BOOLEAN)
```

- Password credentials

```plaintext
  user_id (FK, users)
  hash (argon2id),
  pepper_version (INT)
```

- WebAuthn credentials

```plaintext
  user_id (FK, users)
  credential_id (VARCHAR, unique)
  public_key (TEXT)
  sign_count (INT)
```

- Social identities (social_identities)

```plaintext
  id (UUID, PK)
  user_id (FK, users)
  provider (ENUM: google, facebook, etc.)
  provider_user_id (VARCHAR)
  access_token (TEXT)
  refresh_token (TEXT)
  expires_at (TIMESTAMP)
```

- Oauth clients (oauth_clients)

```plaintext
  id (UUID, PK)
  user_id (FK, users)
  client_id (VARCHAR, unique)
  client_secret (VARCHAR)
  redirect_uris (TEXT[])
  created_at (TIMESTAMP)
  updated_at (TIMESTAMP)
```

- Oauth authorized codes (oauth_authorization_codes)

```plaintext
  code (VARCHAR, PK)
  client_id (FK, oauth_clients)
  user_id (FK, users)
  redirect_uri (VARCHAR)
  scope (TEXT[])
  expires_at (TIMESTAMP)
```

- Oauth tokens (oauth_tokens)

```plaintext
  token (VARCHAR, PK)
  client_id (FK, oauth_clients)
  user_id (FK, users)
  scope (TEXT[])
  issued_at (TIMESTAMP)
  expires_at (TIMESTAMP)
  is_revoked (BOOLEAN)
```

- Oauth consents (oauth_consents)

```plaintext
  id (UUID, PK)
  user_id (FK, users)
  client_id (FK, oauth_clients)
  scope (TEXT[])
  created_at (TIMESTAMP)
  updated_at (TIMESTAMP)
```
